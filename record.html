<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° é–‹æ”¯è¨˜éŒ„ - æ—¥æœ¬é—œè¥¿8å¤©è‡ªé§•éŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #202020;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .person-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .person-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .person-card.kaho {
            border-top: 4px solid #2196F3;
        }

        .person-card.dicken {
            border-top: 4px solid #4CAF50;
        }

        .person-card.couple {
            border-top: 4px solid #FF9800;
        }

        .person-card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-card .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .person-card .stat-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1em;
            color: #667eea;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #667eea;
        }

        .settlement-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .settlement-card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .settlement-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .settlement-arrow {
            font-size: 1.5em;
            color: #667eea;
        }

        .day-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
        }

        .day-header:hover {
            background: #f8f9fa;
        }

        .day-header h3 {
            font-size: 1.3em;
            color: #667eea;
        }

        .day-summary {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .day-content {
            display: none;
            margin-top: 20px;
        }

        .day-content.active {
            display: block;
        }

        .expense-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #2196F3;
        }

        .expense-item.personal {
            border-left-color: #FF9800;
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .expense-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            background: #2196F3;
            color: white;
        }

        .expense-type.personal {
            background: #FF9800;
        }

        .expense-amount {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .expense-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .add-expense-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 15px;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
        }

        .add-expense-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 44px;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            position: relative;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-label {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: white;
            font-weight: 500;
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .radio-option input[type="radio"]:checked + .radio-label.group {
            background: #2196F3;
            border-color: #2196F3;
        }

        .radio-option input[type="radio"]:checked + .radio-label.personal {
            background: #FF9800;
            border-color: #FF9800;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .reset-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 30px auto;
            display: block;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
        }

        .reset-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .kuse-branding {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: white;
            opacity: 0.9;
            font-size: 0.9em;
            cursor: pointer;
            transition: opacity 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .kuse-branding:hover {
            opacity: 1;
        }

        .kuse-branding svg {
            height: 1.2em;
            vertical-align: middle;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .person-stats {
                grid-template-columns: 1fr;
            }

            .day-header h3 {
                font-size: 1.1em;
            }

            .day-summary {
                flex-direction: column;
                gap: 5px;
                align-items: flex-end;
            }

            .expense-details {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .modal-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .stat-card .amount {
                font-size: 1.5em;
            }

            .person-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° é–‹æ”¯è¨˜éŒ„</h1>
            <p>æ—¥æœ¬é—œè¥¿8å¤©è‡ªé§•éŠ</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>ç¸½æ”¯å‡º</h3>
                <div class="amount" id="totalExpense">HKD 0</div>
            </div>
            <div class="stat-card">
                <h3>åœ˜é«”é–‹æ”¯</h3>
                <div class="amount" id="groupExpense">HKD 0</div>
            </div>
            <div class="stat-card">
                <h3>å€‹äººé–‹æ”¯</h3>
                <div class="amount" id="personalExpense">HKD 0</div>
            </div>
            <div class="stat-card">
                <h3>æ”¯å‡ºç­†æ•¸</h3>
                <div class="amount" id="expenseCount">0</div>
            </div>
        </div>

        <div class="person-stats">
            <div class="person-card kaho">
                <h2>ğŸ‘¤ Kaho</h2>
                <div class="stat-row">
                    <span>å¯¦éš›æ”¯ä»˜ï¼š</span>
                    <span id="kahoPaid">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>å€‹äººé–‹æ”¯ï¼š</span>
                    <span id="kahoPersonal">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>åœ˜é«”é–‹æ”¯æ‡‰åˆ†æ”¤ï¼š</span>
                    <span id="kahoShare">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>ç¸½è¨ˆï¼š</span>
                    <span id="kahoTotal">HKD 0</span>
                </div>
            </div>

            <div class="person-card dicken">
                <h2>ğŸ‘¤ Dicken</h2>
                <div class="stat-row">
                    <span>å¯¦éš›æ”¯ä»˜ï¼š</span>
                    <span id="dickenPaid">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>å€‹äººé–‹æ”¯ï¼š</span>
                    <span id="dickenPersonal">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>åœ˜é«”é–‹æ”¯æ‡‰åˆ†æ”¤ï¼š</span>
                    <span id="dickenShare">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>ç¸½è¨ˆï¼š</span>
                    <span id="dickenTotal">HKD 0</span>
                </div>
            </div>

            <div class="person-card couple">
                <h2>ğŸ‘« æ³°æ°å¤«å©¦</h2>
                <div class="stat-row">
                    <span>å¯¦éš›æ”¯ä»˜ï¼š</span>
                    <span id="couplePaid">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>å€‹äººé–‹æ”¯ï¼š</span>
                    <span id="couplePersonal">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>åœ˜é«”é–‹æ”¯æ‡‰åˆ†æ”¤ï¼ˆ2äººï¼‰ï¼š</span>
                    <span id="coupleShare">HKD 0</span>
                </div>
                <div class="stat-row">
                    <span>ç¸½è¨ˆï¼š</span>
                    <span id="coupleTotal">HKD 0</span>
                </div>
            </div>
        </div>

        <div class="settlement-card">
            <h2>ğŸ’¸ è²»ç”¨çµç®—</h2>
            <div id="settlementContent"></div>
        </div>

        <div id="daysContainer"></div>

        <button class="reset-btn" onclick="resetAllData()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è¨˜éŒ„</button>

        <div class="kuse-branding" onclick="window.open('https://kuse.ai', '_blank')">
            made with <svg viewBox="0,0,160,44" xmlns="http://www.w3.org/2000/svg"><path d="m.01,20.65C-.43,8.25,9.3-2.03,22.04.34,34.78,2.72,43.29,8.32,43.29,22.9s-8.66,19.01-22.03,20.3C7.9,44.5.46,33.05.01,20.65z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="m146.76,7.94c8.07,0,13.24,6.15,13.24,14.58v1.39h-20.75c.45,4.05,3.51,7.37,8.57,7.37,2.62,0,5.73-1.05,7.62-2.94l2.67,3.83c-2.67,2.55-6.62,3.88-10.9,3.88-8.07,0-14.08-5.6-14.08-14.08,0-7.76,5.67-14.02,13.63-14.02zm0,4.77c-5.01,0-7.29,3.83-7.57,7.1h15.13c-.11-3.16-2.28-7.1-7.57-7.1z" fill="currentColor"/><path d="m86.64,24.49c0,4.15,2.39,6.84,6.84,6.84,4.4,0,6.84-2.69,6.84-6.84V8.55h5.37v16.33c0,6.7-4.06,11.14-12.21,11.14-8.21,0-12.21-4.5-12.21-11.09V8.55h5.37v15.94zm32.99-16.55c4.49,0,8.06,1.47,10.6,3.86l-2.59,3.81c-2.05-2-5.28-3.08-8.06-3.08-2.88,0-4.84,1.37-4.84,3.32,0,1.91,2.64,2.54,5.81,3.27,4.59,1.08,10.26,2.4,10.26,8.46,0,4.94-3.76,8.41-11.14,8.41-4.98,0-8.94-1.76-11.24-4.11l2.54-4.11c1.86,1.91,5.18,3.67,8.84,3.67,3.91,0,5.57-1.66,5.57-3.62,0-2.3-2.88-2.98-6.21-3.76-4.54-1.08-9.87-2.3-9.87-8.06,0-4.5,4.2-8.06,10.31-8.06zM60.79,20.82,71.44,8.55h6.5L66.46,21.26,78.82,35.44h-6.5l-9.28-11.1-2.25,2.49v8.6h-5.33V8.55h5.33v12.27z" fill="currentColor"/></svg>
        </div>
    </div>

    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <h2>â• æ–°å¢é–‹æ”¯</h2>
            <form id="expenseForm">
                <div class="form-group">
                    <label>æ”¯ä»˜äºº *</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="payer" value="Kaho" id="payerKaho" required>
                            <label for="payerKaho" class="radio-label">ğŸ‘¤ Kaho</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="payer" value="Dicken" id="payerDicken">
                            <label for="payerDicken" class="radio-label">ğŸ‘¤ Dicken</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="payer" value="æ³°æ°å¤«å©¦" id="payerCouple">
                            <label for="payerCouple" class="radio-label">ğŸ‘« æ³°æ°å¤«å©¦</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>é–‹æ”¯é¡åˆ¥ *</label>
                    <select name="category" required>
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="æ—©é¤">ğŸ³ æ—©é¤</option>
                        <option value="åˆé¤">ğŸ± åˆé¤</option>
                        <option value="æ™šé¤">ğŸ½ï¸ æ™šé¤</option>
                        <option value="é–€ç¥¨">ğŸ« é–€ç¥¨</option>
                        <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                        <option value="ä½å®¿">ğŸ¨ ä½å®¿</option>
                        <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="å’–å•¡/å°é£Ÿ">â˜• å’–å•¡/å°é£Ÿ</option>
                        <option value="é›œè²»">ğŸ“ é›œè²»</option>
                        <option value="å…¶ä»–">ğŸ’¡ å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ”¯ä»˜é¡åˆ¥ *</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="type" value="group" id="typeGroup" checked>
                            <label for="typeGroup" class="radio-label group">ğŸ‘¥ åœ˜é«”é–‹æ”¯</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="type" value="personal" id="typePersonal">
                            <label for="typePersonal" class="radio-label personal">ğŸ‘¤ å€‹äººé–‹æ”¯</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>é‡‘é¡ *</label>
                    <input type="number" name="amount" step="0.01" min="0" placeholder="0.00" required>
                </div>

                <div class="form-group">
                    <label>è²¨å¹£ *</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="currency" value="HKD" id="currencyHKD" checked>
                            <label for="currencyHKD" class="radio-label">HKD</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="currency" value="JPY" id="currencyJPY">
                            <label for="currencyJPY" class="radio-label">JPY</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea name="note" rows="3" placeholder="é¸å¡«"></textarea>
                </div>

                <input type="hidden" name="day" id="expenseDay">

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç¢ºèªæ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.kuse.ai/sdk.prd.js"></script>
    <script>
        const JPY_TO_HKD = 0.055;
        const DAYS = 8;

        let expenses = JSON.parse(localStorage.getItem(`expenses`) || `[]`);

        const prepaidExpenses = {
            kaho: 10475.2,
            dicken: 780,
            couple: 2286
        };

        function initializeDays() {
            const container = document.getElementById(`daysContainer`);
            container.innerHTML = ``;

            for (let i = 1; i <= DAYS; i++) {
                const dayExpenses = expenses.filter(e => e.day === i);
                const dayTotal = dayExpenses.reduce((sum, e) => sum + e.amountHKD, 0);

                const daySection = document.createElement(`div`);
                daySection.className = `day-section`;
                daySection.innerHTML = `
                    <div class="day-header" onclick="toggleDay(${i})">
                        <h3>ğŸ“… Day ${i}</h3>
                        <div class="day-summary">
                            <span>${dayExpenses.length} ç­†</span>
                            <span style="font-weight: 700; color: #667eea;">HKD ${dayTotal.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="day-content" id="day${i}Content">
                        <div id="day${i}Expenses"></div>
                        <button class="add-expense-btn" onclick="openModal(${i})">â• æ–°å¢é–‹æ”¯</button>
                    </div>
                `;
                container.appendChild(daySection);

                renderDayExpenses(i);
            }
        }

        function toggleDay(day) {
            const content = document.getElementById(`day${day}Content`);
            content.classList.toggle(`active`);
        }

        function renderDayExpenses(day) {
            const container = document.getElementById(`day${day}Expenses`);
            const dayExpenses = expenses.filter(e => e.day === day);

            if (dayExpenses.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #999; padding: 20px;">æš«ç„¡è¨˜éŒ„</p>`;
                return;
            }

            container.innerHTML = dayExpenses.map((expense, index) => `
                <div class="expense-item ${expense.type}">
                    <div class="expense-header">
                        <span class="expense-type ${expense.type}">${expense.type === `group` ? `ğŸ‘¥ åœ˜é«”é–‹æ”¯` : `ğŸ‘¤ å€‹äººé–‹æ”¯`}</span>
                        <span class="expense-amount">HKD ${expense.amountHKD.toFixed(2)}</span>
                    </div>
                    <div class="expense-details">
                        <div><strong>æ”¯ä»˜äººï¼š</strong>${expense.payer}</div>
                        <div><strong>é¡åˆ¥ï¼š</strong>${expense.category}</div>
                        <div><strong>åŸé‡‘é¡ï¼š</strong>${expense.currency} ${expense.amount.toFixed(2)}</div>
                        ${expense.note ? `<div><strong>å‚™è¨»ï¼š</strong>${expense.note}</div>` : ``}
                    </div>
                    <button class="delete-btn" onclick="deleteExpense(${day}, ${index})">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            `).join(``);
        }

        function openModal(day) {
            document.getElementById(`expenseDay`).value = day;
            document.getElementById(`expenseForm`).reset();
            document.getElementById(`expenseModal`).classList.add(`active`);
        }

        function closeModal() {
            document.getElementById(`expenseModal`).classList.remove(`active`);
        }

        document.getElementById(`expenseForm`).addEventListener(`submit`, function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const amount = parseFloat(formData.get(`amount`));
            const currency = formData.get(`currency`);
            const amountHKD = currency === `JPY` ? amount * JPY_TO_HKD : amount;

            const expense = {
                day: parseInt(formData.get(`day`)),
                payer: formData.get(`payer`),
                category: formData.get(`category`),
                type: formData.get(`type`),
                amount: amount,
                currency: currency,
                amountHKD: amountHKD,
                note: formData.get(`note`) || ``
            };

            expenses.push(expense);
            saveExpenses();
            closeModal();
            initializeDays();
            updateStatistics();
        });

        function deleteExpense(day, index) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ`)) return;

            const dayExpenses = expenses.filter(e => e.day === day);
            const expenseToDelete = dayExpenses[index];
            const globalIndex = expenses.indexOf(expenseToDelete);

            expenses.splice(globalIndex, 1);
            saveExpenses();
            renderDayExpenses(day);
            updateStatistics();
        }

        function saveExpenses() {
            localStorage.setItem(`expenses`, JSON.stringify(expenses));
        }

        function updateStatistics() {
            const totalExpense = expenses.reduce((sum, e) => sum + e.amountHKD, 0);
            const groupExpense = expenses.filter(e => e.type === `group`).reduce((sum, e) => sum + e.amountHKD, 0);
            const personalExpense = expenses.filter(e => e.type === `personal`).reduce((sum, e) => sum + e.amountHKD, 0);

            document.getElementById(`totalExpense`).textContent = `HKD ${totalExpense.toFixed(2)}`;
            document.getElementById(`groupExpense`).textContent = `HKD ${groupExpense.toFixed(2)}`;
            document.getElementById(`personalExpense`).textContent = `HKD ${personalExpense.toFixed(2)}`;
            document.getElementById(`expenseCount`).textContent = expenses.length;

            const kahoPaid = prepaidExpenses.kaho + expenses.filter(e => e.payer === `Kaho`).reduce((sum, e) => sum + e.amountHKD, 0);
            const dickenPaid = prepaidExpenses.dicken + expenses.filter(e => e.payer === `Dicken`).reduce((sum, e) => sum + e.amountHKD, 0);
            const couplePaid = prepaidExpenses.couple + expenses.filter(e => e.payer === `æ³°æ°å¤«å©¦`).reduce((sum, e) => sum + e.amountHKD, 0);

            const kahoPersonal = expenses.filter(e => e.payer === `Kaho` && e.type === `personal`).reduce((sum, e) => sum + e.amountHKD, 0);
            const dickenPersonal = expenses.filter(e => e.payer === `Dicken` && e.type === `personal`).reduce((sum, e) => sum + e.amountHKD, 0);
            const couplePersonal = expenses.filter(e => e.payer === `æ³°æ°å¤«å©¦` && e.type === `personal`).reduce((sum, e) => sum + e.amountHKD, 0);

            const kahoShare = groupExpense / 4;
            const dickenShare = groupExpense / 4;
            const coupleShare = groupExpense / 2;

            const kahoTotal = kahoPersonal + kahoShare;
            const dickenTotal = dickenPersonal + dickenShare;
            const coupleTotal = couplePersonal + coupleShare;

            document.getElementById(`kahoPaid`).textContent = `HKD ${kahoPaid.toFixed(2)}`;
            document.getElementById(`kahoPersonal`).textContent = `HKD ${kahoPersonal.toFixed(2)}`;
            document.getElementById(`kahoShare`).textContent = `HKD ${kahoShare.toFixed(2)}`;
            document.getElementById(`kahoTotal`).textContent = `HKD ${kahoTotal.toFixed(2)}`;

            document.getElementById(`dickenPaid`).textContent = `HKD ${dickenPaid.toFixed(2)}`;
            document.getElementById(`dickenPersonal`).textContent = `HKD ${dickenPersonal.toFixed(2)}`;
            document.getElementById(`dickenShare`).textContent = `HKD ${dickenShare.toFixed(2)}`;
            document.getElementById(`dickenTotal`).textContent = `HKD ${dickenTotal.toFixed(2)}`;

            document.getElementById(`couplePaid`).textContent = `HKD ${couplePaid.toFixed(2)}`;
            document.getElementById(`couplePersonal`).textContent = `HKD ${couplePersonal.toFixed(2)}`;
            document.getElementById(`coupleShare`).textContent = `HKD ${coupleShare.toFixed(2)}`;
            document.getElementById(`coupleTotal`).textContent = `HKD ${coupleTotal.toFixed(2)}`;

            calculateSettlement(kahoPaid, kahoTotal, dickenPaid, dickenTotal, couplePaid, coupleTotal);
        }

        function calculateSettlement(kahoPaid, kahoTotal, dickenPaid, dickenTotal, couplePaid, coupleTotal) {
            const kahoBalance = kahoPaid - kahoTotal;
            const dickenBalance = dickenPaid - dickenTotal;
            const coupleBalance = couplePaid - coupleTotal;

            const balances = [
                { name: `Kaho`, balance: kahoBalance },
                { name: `Dicken`, balance: dickenBalance },
                { name: `æ³°æ°å¤«å©¦`, balance: coupleBalance }
            ];

            const debtors = balances.filter(b => b.balance < 0).map(b => ({ ...b, balance: Math.abs(b.balance) }));
            const creditors = balances.filter(b => b.balance > 0);

            const settlements = [];

            for (const debtor of debtors) {
                let remaining = debtor.balance;

                for (const creditor of creditors) {
                    if (remaining <= 0) break;
                    if (creditor.balance <= 0) continue;

                    const amount = Math.min(remaining, creditor.balance);
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: amount
                    });

                    remaining -= amount;
                    creditor.balance -= amount;
                }
            }

            const settlementContent = document.getElementById(`settlementContent`);

            if (settlements.length === 0) {
                settlementContent.innerHTML = `<p style="text-align: center; color: #4CAF50; font-weight: 600;">âœ… è²»ç”¨å·²çµæ¸…ï¼</p>`;
            } else {
                settlementContent.innerHTML = settlements.map(s => `
                    <div class="settlement-item">
                        <strong>${s.from}</strong>
                        <span class="settlement-arrow">â†’</span>
                        <strong>${s.to}</strong>
                        <span style="margin-left: auto; font-weight: 700; color: #667eea;">HKD ${s.amount.toFixed(2)}</span>
                    </div>
                `).join(``);
            }
        }

        function resetAllData() {
            if (!confirm(`ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

            expenses = [];
            localStorage.removeItem(`expenses`);
            initializeDays();
            updateStatistics();
            alert(`âœ… å·²é‡ç½®æ‰€æœ‰è¨˜éŒ„ï¼`);
        }

        window.onclick = function(event) {
            const modal = document.getElementById(`expenseModal`);
            if (event.target === modal) {
                closeModal();
            }
        };

        initializeDays();
        updateStatistics();
    </script>
</body>
</html>